<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahsil Teladan Official</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #2E7D32; --secondary: #1565C0; --bg: #f0fdf4; --header-bg: #e8f5e9; }
        body, html { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; }
        
        /* 1. SPLASH SCREEN (MainActivity.kt) */
        #splashScreen { background: white; height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; position: fixed; width: 100%; z-index: 9999; }
        .logo-box { width: 90px; height: 90px; background: var(--primary); border-radius: 22px; display: flex; justify-content: center; align-items: center; color: white; font-size: 45px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }

        /* 2. LAYOUT PAGES */
        .page { padding: 20px; display: none; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .container { width: 100%; max-width: 480px; }
        
        /* 3. CARDS & ITEMS (MuridAdapter.kt) */
        .group-header { width: 100%; padding: 10px 15px; background: var(--header-bg); color: var(--primary); font-weight: bold; font-size: 13px; border-radius: 10px; margin: 15px 0 8px 0; border-left: 5px solid var(--primary); box-sizing: border-box; }
        .item-murid { background: white; padding: 18px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: 0.2s; border: 1px solid #eee; }
        .item-murid:active { transform: scale(0.97); background: #f9f9f9; }

        /* 4. FORM STYLES (InputCapaianActivity.kt) */
        .card-form { background: white; padding: 25px; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border-top: 10px solid var(--primary); }
        label { display: block; margin-top: 15px; font-weight: bold; font-size: 12px; color: #555; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 14px; margin: 6px 0; border: 1.5px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 15px; outline: none; }
        .char-counter { text-align: right; font-size: 11px; color: #888; margin-bottom: 10px; }

        /* 5. BUTTONS */
        .btn { width: 100%; padding: 18px; border: none; border-radius: 15px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-green { background: var(--primary); color: white; }
        .btn-blue { background: var(--secondary); color: white; }
        .btn-back { background: none; color: #888; font-weight: bold; margin-top: 20px; border: 1px solid #ddd; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="splashScreen">
        <div class="logo-box">T</div>
        <h2 style="color: var(--primary); margin-top: 20px;">TAHSIL TELADAN</h2>
        <p style="color: #999;">Mencetak Generasi Rabbani</p>
    </div>

    <div id="activity_home" class="page">
        <div class="container" style="text-align: center; margin-top: 60px;">
            <h2>Selamat Datang</h2>
            <button class="btn btn-green" onclick="showPage('activity_login_guru')">LOGIN GURU</button>
            <button class="btn btn-blue" onclick="showPage('activity_login_wali')">LOGIN WALI MURID</button>
            <p style="margin-top: 50px; font-size: 10px; color: #bbb;">BY TB AZMI UMAR FAUZI</p>
        </div>
    </div>

    <div id="activity_login_guru" class="page">
        <div class="container">
            <h2>Akses Guru</h2>
            <input type="text" id="etNamaGuru" placeholder="Nama Panggilan">
            <input type="password" id="etNIY" placeholder="Masukkan NIY">
            <button class="btn btn-green" onclick="performLoginGuru()">MASUK</button>
            <button class="btn btn-back" onclick="showPage('activity_home')">KEMBALI</button>
        </div>
    </div>

    <div id="activity_login_wali" class="page">
        <div class="container">
            <h2>Laporan Ananda</h2>
            <input type="text" id="etNamaAnanda" placeholder="NAMA LENGKAP KAPITAL">
            <input type="date" id="etTglLahir">
            <button class="btn btn-blue" onclick="performLoginWali()">CEK PROGRES</button>
            <button class="btn btn-back" onclick="showPage('activity_home')">KEMBALI</button>
        </div>
    </div>

    <div id="activity_daftar_murid" class="page">
        <div class="container">
            <h3 id="welcomeGuru" style="color: var(--primary);">Selamat Bertugas</h3>
            <button class="btn btn-blue" onclick="downloadRekap()" style="font-size: 14px; margin-bottom: 15px;">UNDUH REKAP EXCEL</button>
            <div id="rvMurid"></div>
            <button class="btn btn-back" onclick="location.reload()">LOGOUT</button>
        </div>
    </div>

    <div id="activity_input" class="page">
        <div class="container card-form">
            <h3 id="targetNama" style="margin: 0; color: var(--primary);"></h3>
            <p id="targetKls" style="font-size: 12px; color: #999; margin-top: 5px;"></p>
            
            <div id="layoutReguler">
                <label>Tilawati / Al-Qur'an</label>
                <div style="display: flex; gap: 8px;">
                    <select id="spJilid"><option>Pilih Jilid</option><option>Jilid 1</option><option>Jilid 2</option><option>Jilid 3</option><option>Jilid 4</option><option>Jilid 5</option><option>Jilid 6</option></select>
                    <input type="text" id="spHalaman" placeholder="Hal">
                </div>
                <select id="spPredikatReguler" onchange="autoGenerateNote()"><option>Pilih Nilai</option><option>A (Sangat Baik)</option><option>B (Baik)</option><option>C (Cukup)</option></select>
            </div>

            <label>Setoran Hafalan</label>
            <input type="text" id="etHafalan" placeholder="Contoh: An-Naba 1-10">
            <select id="spPredikatHafalan" onchange="autoGenerateNote()"></select>

            <div id="layoutCatatan">
                <label>Catatan Guru (Otomatis)</label>
                <textarea id="etCatatan" rows="4" maxlength="360" oninput="updateCounter()"></textarea>
                <div id="charCounter" class="char-counter">0/360</div>
            </div>

            <button class="btn btn-green" id="btnSimpan" onclick="simpanData()">SIMPAN DATA</button>
            <button class="btn btn-back" onclick="showPage('activity_daftar_murid')">BATAL</button>
        </div>
    </div>

    <div id="activity_hasil_wali" class="page">
        <div class="container">
            <h3 id="tvNamaAnanda" style="color: var(--secondary);">Laporan Capaian</h3>
            <div id="listProgres"></div>
            <button class="btn btn-back" onclick="location.reload()">KELUAR</button>
        </div>
    </div>

<script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzRsZ2ZVFUeoeyGT2jVtEBrqzq5zDE904vNGBwDjdL_okndWBRt6_LdZLMcP_SAeC42/exec";
    let activeGuru = ""; let selectedSiswa = {};

    // DATABASE GURU & NIY
    const dbGuru = { "Pak Tebe": "020694", "Pak Yusuf": "040393", "Bu Arrum": "280700", "Pak Irhas": "100801", "Bu Acha": "110499", "Pak Adieb": "140491", "Bu Rifa": "030198", "Pak Anas": "260797", "Bu Mela": "220896", "Bu Ina": "070593", "Pak Hilmi": "020493", "Pak Oky": "121096" };

    // DATABASE SISWA (339 Nama)
    const dbSiswa = { "ABDULLAH HAMIM HARIMURTI": "2019-07-14", "ADIBA SHAKILA QORRI AINA AHMAD": "2019-02-10", "AHMAD YUSUF DANISWORO": "2016-12-11", "ALMAHYRA SHANEISHA ANINDIRA ISA S": "2019-06-22", "AMANULLAH ZAIN": "2019-05-02" /* Tambahkan sisa data lainnya di sini sesuai format */ };

    // DATABASE MURID PER GURU
    const dbMuridGuru = {
        "Pak Oky": [ {n: "Ahmad Yusuf Danisworo", k: "Kelas 1A", t: "Reguler"}, {n: "Abdullah Hamim Harimurti", k: "Kelas 1A", t: "Reguler"}, {n: "Adiba Ayunazahra Mahendra", k: "Kelas 3A", t: "Khusus Tahfidz Kelas 3"} ],
        "Pak Tebe": [ {n: "Freya Safira Yasmin Fitaly", k: "Kelas 1B", t: "Reguler"}, {n: "Al Kahfi Hadianto", k: "Kelas 3C", t: "Khusus Tahfidz Kelas 3"} ]
    };

    // SPLASH TIMER (MainActivity.kt)
    setTimeout(() => { document.getElementById('splashScreen').style.display = 'none'; showPage('activity_home'); }, 3000);

    function showPage(id) { document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); document.getElementById(id).style.display = 'flex'; }

    function performLoginGuru() {
        const n = document.getElementById('etNamaGuru').value; const p = document.getElementById('etNIY').value;
        if (dbGuru[n] === p) { activeGuru = n; document.getElementById('welcomeGuru').innerText = "Ust/Ustzh " + n; renderMurid(); showPage('activity_daftar_murid'); } 
        else { alert("Login Gagal!"); }
    }

    function renderMurid() {
        const rv = document.getElementById('rvMurid'); rv.innerHTML = "";
        const list = dbMuridGuru[activeGuru] || [];
        list.forEach((m, idx) => {
            // Header Logic (MuridAdapter.kt)
            if (idx === 0 || m.t !== list[idx-1].t) {
                const h = document.createElement('div'); h.className = "group-header"; h.innerText = m.t; rv.appendChild(h);
            }
            const item = document.createElement('div'); item.className = "item-murid";
            item.innerHTML = `<div><b>${m.n}</b><br><small>${m.k}</small></div><div class="btn-pdf" onclick="event.stopPropagation(); window.open('${webAppUrl}?action=pdf&name=${m.n}')">PDF</div>`;
            item.onclick = () => openInput(m);
            rv.appendChild(item);
        });
    }

    function openInput(m) {
        selectedSiswa = m;
        document.getElementById('targetNama').innerText = m.n; document.getElementById('targetKls').innerText = m.k;
        const isKhusus = m.t.includes("Khusus");
        document.getElementById('layoutReguler').className = isKhusus ? "hidden" : "";
        document.getElementById('layoutCatatan').className = isKhusus ? "hidden" : "";
        document.getElementById('spPredikatHafalan').innerHTML = isKhusus 
            ? '<option>A (Sangat Lancar)</option><option>B (Lancar)</option><option>C (Cukup Lancar)</option><option>D (Perlu Murojaah)</option>'
            : '<option>A (Sangat Baik)</option><option>B (Baik)</option><option>C (Cukup)</option>';
        showPage('activity_input');
    }

    // AUTO NOTE LOGIC (InputCapaianActivity.kt)
    function autoGenerateNote() {
        if(selectedSiswa.t.includes("Khusus")) return;
        const score = (p) => p.includes("A") ? 3 : p.includes("B") ? 2 : p.includes("C") ? 1 : 0;
        const avg = (score(document.getElementById('spPredikatReguler').value) + score(document.getElementById('spPredikatHafalan').value)) / 2;
        const pred = avg >= 2.5 ? "sangat baik" : avg >= 1.5 ? "baik" : "cukup baik";
        document.getElementById('etCatatan').value = `Alhamdulillah, ananda mengikuti tahfidz dengan ${pred}. Mohon pendampingan Bapak/Ibu agar ananda istiqomah.`;
        updateCounter();
    }

    function updateCounter() {
        const len = document.getElementById('etCatatan').value.length;
        document.getElementById('charCounter').innerText = `${len}/360`;
        document.getElementById('charCounter').style.color = len >= 350 ? "red" : "#888";
    }

    function performLoginWali() {
        const n = document.getElementById('etNamaAnanda').value.toUpperCase(); const t = document.getElementById('etTglLahir').value;
        if (dbSiswa[n] === t) { document.getElementById('tvNamaAnanda').innerText = "Laporan " + n; showPage('activity_hasil_wali'); fetchResults(n); }
        else { alert("Data tidak ditemukan."); }
    }

    function fetchResults(nama) {
        const list = document.getElementById('listProgres'); list.innerHTML = "Memuat data...";
        fetch(webAppUrl + "?nama=" + nama).then(res => res.json()).then(data => {
            if(data.length === 0) return list.innerHTML = "Belum ada riwayat.";
            let h = ""; data.forEach(d => { h += `<div class="item-murid" style="flex-direction:column; align-items:start;"><b>${d.tanggal}</b><span>Hafalan: ${d.hafalan}</span><span>Predikat: ${d.predikat}</span></div>`; });
            list.innerHTML = h;
        });
    }

    function simpanData() {
        const btn = document.getElementById('btnSimpan'); btn.innerText = "Menyimpan..."; btn.disabled = true;
        const params = new URLSearchParams({ guru: activeGuru, nama_siswa: selectedSiswa.n, kls: selectedSiswa.k, hafalan: document.getElementById('etHafalan').value, predikat_hafalan: document.getElementById('spPredikatHafalan').value, catatan: document.getElementById('etCatatan').value || "-" });
        fetch(webAppUrl, { method: 'POST', mode: 'no-cors', body: params }).then(() => { alert("Tersimpan!"); showPage('activity_daftar_murid'); btn.disabled = false; btn.innerText = "SIMPAN DATA"; });
    }

    function downloadRekap() { window.open(webAppUrl + "?action=download&guru=" + activeGuru, '_blank'); }
</script>
</body>
</html>
